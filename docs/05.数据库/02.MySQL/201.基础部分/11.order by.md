---
title: order by
date: 2023-06-24 16:17:23
permalink: /pages/b8f0e6/
categories:
  - 数据库
  - MySQL
  - 基础部分
tags:
  - 数据库
author: 
  name: phan
  link: https://gitee.com/blage-coding
---
# order by

## 1.全字段排序

分析以下SQL语句执行流程，city字段建立了索引。

```sql
select city,name,age from t where city='杭州' order by name limit 1000 ;
```

- 首先从city的索引B+树叶子节点，获取每行记录的主键ID，然后从主键索引树的每一行记录中，取出查询的三个字段。
- <font color="red">**在内存开辟一个用于排序的空间sort_buffer**</font>，并指定空间大小。
- 将每行记录三个字段都放入sort_buffer，然后根据name字段进行快排(内部排序)。放入内存排序可能存在两种情况：
  - sort_buffer空间大小 > 所有要排序的数据量：此时需要进行**外部排序**，将所有数据分块并依次放入sort_buffer进行排序，每个有序的块排序好后会存放在“**临时文件**”中，最后将每块有序的临时文件通过**归并排序**合并成一个大的有序的文件。
  - sort_buffer空间大小 ＜ 所有要排序的数据量：直接在**内存**进行排序。
- 把排序后前1000条结果返回给客户端。

SQL语句排序时可以通过查看**OPTIMIZER_TRACE**结果，对执行排序的SQL语句进行分析，其中介绍几个字段的含义：

“number_of_tmp_files”：表示使用到了临时文件的数量，**内存开辟的排序空间越小，使用到的临时文件越多**。

“examined_rows”：参与排序的行数。

“sort_mode ”里面的packed_additional_fields：表示对字符串进行了紧凑处理，按照**实际字符串长度分配空间**。Varchar定义的长度无效。

## 2.rowId排序


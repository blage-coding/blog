---
title: 数据库表的空间回收
date: 2023-06-20 21:16:52
permalink: /pages/00835e/
categories:
  - 数据库
  - MySQL
  - 基础部分
tags:
  - 数据库
author: 
  name: phan
  link: https://gitee.com/blage-coding
---
# 数据库表的空间回收

**innodb_file_per_table**：控制表数据的存在形式。设置为ON表示数据存放在.ibd为后缀的文件中。**设置为OFF表示数据存放在共享表空间，这种情况下即使表删除了空间不会回收**。因此一般情况下**推荐设置为ON**。

## 1.数据删除插入流程

无论是删除还是插入**，数据更新后表空间处于可复用但是还未被使用的空间**，都属于“空洞”。这些空洞尚未被InnoDB释放回收，从而导致数据页空间利用率比较低。

- **删除**

**复用**：无论是删除innoDB索引树上的一条记录，还是删除一个数据页上的所有记录。<font color="red">**InnoDB并不会直接将整行记录或者整个数据页都删除，而是在这条记录的位置或者这个数据页上标记为“可复用**</font>”，这样新的数据插入后直接使用原本的空间即可。

其中行复用和页复用的区别在于，**新插入行复用位置的记录ID，会受到原先位置记录的约束**。而页复用则不受任何数据索引或者是主键的限制。

- **插入**

举个例子，原先数据页中**某条记录**，由于插入新的记录导致数据页分裂，与新记录合并存放到新的数据页。此时该条数据原先所在的位置就是数据空洞。

## 2.重建表

新建一张表，将旧的存在多个空洞的表数据全部一行一行拷贝到新表当中。显然得到的新表中<font color="red">**数据页利用率更高，并且主键索引更加紧凑**</font>。

- **Online DDL**

显然上述过程
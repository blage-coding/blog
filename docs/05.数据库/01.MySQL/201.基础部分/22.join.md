---
title: join
date: 2023-07-09 18:11:52
permalink: /pages/6ffe7c/
categories:
  - 数据库
  - MySQL
  - 基础部分
tags:
  - 数据库
author: 
  name: phan
  link: https://gitee.com/blage-coding
---
# join

使用join存在什么问题？下面围绕join语句的执行流程，使用前面学过的索引知识展开。

## join语句执行流程

场景：t1和t2表同时都有主键id，索引字段a，无索引字段b。t2表插入了1000行数据，t1表中插入了100行数据。

### 1.索引join查询

使用<font style="background: rgb(240, 240, 236)" color="#d94a33">**straight_join**</font>显示指定t1作为驱动表，t2作为被驱动表。整个语句执行过程如下：

```sql
select * from t1 straight_join t2 on (t1.a=t2.a);
```

1. 首先对t1会进行全表查询，然后将每一行扫描的数据放到t2表中进行比较。因此t1总共扫描**100**行数据。
2. 由于是对a字段进行匹配，可以走索引。因此每行t1的行记录都会取出a字段值，在t2的a字段索引树进行比对，然后回表拿到t2的行记录并和t1的行记录拼接。
3. 这里假设t1表中的数据和t2唯一对应。因此t2也会扫描100行数据。总共扫描行数为200。

可以发现在这种条件下的join语句有如下特点：

- **走了索引的join语句比拆成多个单表语句的执行性能好**。如果选择拆成单表的语句，首先从t1拿到全表扫描结果，然后每次取出a字段的值，接着执行100次SQL语句拼接where a=$t1.a。扫描行数虽然和join相同，但是执行了101条SQL语句。
- 驱动表会走全表扫描，因此尽量<font color="red">**让小表作为驱动表**</font>。

### 2.不走索引的join查询

<font color="red">**如果join字段不走索引，那么不适合使用join查询，应该拆成单表**</font>。

#### 2.1不分块

如果是被驱动表没有走索引又会怎么样？t2会扫描100*1000行数据么？实际算法流程如下：

```sql
select * from t1 straight_join t2 on (t1.a=t2.b);
```

1. **将t1表的所有行数据读入线程的内存<font style="background: rgb(240, 240, 236)" color="#d94a33">join_buffer</font>当中**。扫描行数100
2. t2表进行全表扫描，取出扫描到的每行数据，与内存<font style="background: rgb(240, 240, 236)" color="#d94a33">**join_buffer**</font>中的t1表数据进行<font color="red">**比对**</font>，满足连接条件的与t2表记录拼接作为其中一个结果集。扫描行数1000，总共扫描行数1100。**比较判断次数**100*1000=十万次。
3. 相比于t2表直接扫描十万行，时间复杂度相同。但是比较判断操作是在内存进行，因此速度上会快很多。

此时驱动表无论是大表还是小表，比较次数和扫描次数都没有区别。

#### 2.2分块

这里如果<font style="background: rgb(240, 240, 236)" color="#d94a33">**join_buffer**</font>一次性放不下表t1(假设只能放进60行记录)，那么需要将t1表<font color="red">**分块**</font>放进<font style="background: rgb(240, 240, 236)" color="#d94a33">**join_buffer**</font>：

1. 先将t1表前60行记录放入内存。
2. 扫描t2表的所有行记录，并进行比较。此时扫描行数1000条。
3. 将t1表后40行记录放入内存当中。
4. 再次扫描t2表所有记录，并进行比较判断。总比较次数不变还是十万次，而**总扫描函数翻倍**变为2000条。

根据计算，<font color="red">**分块join场景应该让小表作为驱动表，并且应该将join_buffer_size设大一些，从而降低总扫描次数，提高join语句执行效率**</font>。

### 3.总结

::: tip 小表

对于表t1与t2来说，经过where条件筛选后，参与join多表连接的行数据量更小(需要根据select和on条件来判断)的表称之为”小表“。

:::

- 什么情况下使用join语句？
  - 如果被驱动表使用了索引(explain查看Extra字段为<font style="background: rgb(240, 240, 236)" color="#d94a33">**Index Nested-Loop**</font>)，则可以使用join
  - 如果join的字段都用不上索引(explain查看Extra字段为<font style="background: rgb(240, 240, 236)" color="#d94a33">**Block Nested-Loop**</font>)，则不能够使用join。需要拆分成单表SQL语句，避免过多的行扫描。

- 查询语句使用join的情况下，应该<font color="red">**尽量保证”小表“作为驱动表**</font>。
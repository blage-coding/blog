(window.webpackJsonp=window.webpackJsonp||[]).push([[394],{713:function(t,s,r){"use strict";r.r(s);var a=r(4),e=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"如何将一张表的数据插入到另一张表当中"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何将一张表的数据插入到另一张表当中"}},[t._v("#")]),t._v(" 如何将一张表的数据插入到另一张表当中")]),t._v(" "),s("p",[t._v("场景：当前需要从t1表当中取出数据，插入到t2表当中。")]),t._v(" "),s("h2",{attrs:{id:"方法一、insert-select批量插入"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方法一、insert-select批量插入"}},[t._v("#")]),t._v(" 方法一、insert...select批量插入")]),t._v(" "),s("p",[t._v("如果对对源表t1的扫描行数和加锁范围都比较小的情况下，可以使用批量插入的方式。在MySQL8.0版本下，已经支持"),s("strong",[t._v("使用临时表")]),t._v("处理批量插入。")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("insert")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" t2 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" t1 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" a"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("💣存在的问题：如果当前表t1是一个高并发业务表，"),s("strong",[t._v("会把t1锁住，从而影响业务响应时间")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"方法二、mysqldump方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方法二、mysqldump方法"}},[t._v("#")]),t._v(" 方法二、mysqldump方法")]),t._v(" "),s("p",[t._v("使用mysqldump命令将数据导出成一组insert语句：")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[t._v("mysqldump "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("h$host "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("P$port "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("u$"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('--add-locks --no-create-info --single-transaction  --set-gtid-purged=OFF db1 t --where="a>900" --result-file=/client_tmp/t.sql')]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ul",[s("li",[s("font",{staticStyle:{background:"rgb(240, 240, 236)"},attrs:{color:"#d94a33"}},[s("strong",[t._v("–single-transaction")])]),t._v("：导出数据时"),s("strong",[t._v("不需要对t1表加锁")]),t._v("，而是使用START TRANSACTION WITH CONSISTENT SNAPSHOT开启事务，"),s("strong",[t._v("并创建快照读视图")]),t._v("。")],1),t._v(" "),s("li",[s("font",{staticStyle:{background:"rgb(240, 240, 236)"},attrs:{color:"#d94a33"}},[s("strong",[t._v("–add-locks")])]),t._v("：设置为0，表示输出的文件结果里，不增加”Lock tables t write“，即插入数据时不会锁表然后再写。")],1),t._v(" "),s("li",[s("font",{staticStyle:{background:"rgb(240, 240, 236)"},attrs:{color:"#d94a33"}},[s("strong",[t._v("–no-create-info")])]),t._v("：表示不需要导出表结构")],1),t._v(" "),s("li",[s("font",{staticStyle:{background:"rgb(240, 240, 236)"},attrs:{color:"#d94a33"}},[s("strong",[t._v("–set-gtid-purged=off")])]),t._v("：不需要输出t1表里与GTID相关的信息")],1),t._v(" "),s("li",[s("font",{staticStyle:{background:"rgb(240, 240, 236)"},attrs:{color:"#d94a33"}},[s("strong",[t._v("–result-file")])]),t._v("：指定输出文件的路径，client表示输出在客户端机器上")],1)]),t._v(" "),s("p",[t._v("最终得到.sql文件里的insert into语句，value就会包括多条t1表的记录。使用source"),s("strong",[t._v("客户端命令")]),t._v("，执行文件内所有的SQL语句。")]),t._v(" "),s("h2",{attrs:{id:"方法三、导出csv文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方法三、导出csv文件"}},[t._v("#")]),t._v(" 方法三、导出CSV文件")]),t._v(" "),s("h3",{attrs:{id:"数据导出"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据导出"}},[t._v("#")]),t._v(" 数据导出")]),t._v(" "),s("p",[t._v("MySQL提供以下语法将查询结果导出到"),s("strong",[t._v("服务端本地目录")]),t._v("当中：")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" db1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("t wher a"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("900")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("outfile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/server_tmp/t.csv'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("注意以下几个点：")]),t._v(" "),s("ol",[s("li",[t._v("文件结果保存在"),s("font",{attrs:{color:"red"}},[s("strong",[t._v("MySQL服务端")])]),t._v("。")],1),t._v(" "),s("li",[t._v("指定的文件生成位置(/server_tmp)必须受到参数"),s("font",{staticStyle:{background:"rgb(240, 240, 236)"},attrs:{color:"#d94a33"}},[s("strong",[t._v("secure_file_priv")])]),t._v("的限制:\n"),s("ul",[s("li",[t._v("设置为empty：表示不限制文件生成的位置")]),t._v(" "),s("li",[t._v("设置为一个表示路径的字符串：要求生成的文件只能放在这个指定的目录或者他的子目录")]),t._v(" "),s("li",[t._v("设置为NULL：表示禁止在这个MySQL实例上执行上面的csv导出语句")])])],1),t._v(" "),s("li",[t._v("导出命令不会覆盖文件，因此导出之前需要确认在目标文件目录下是否存在t.csv文件。否则会报错")]),t._v(" "),s("li",[t._v("这条命令生成的文本文件中，如果"),s("strong",[t._v("一行数据中某个字段包含换行符")]),t._v("，那么生成的这一行文本也会进行换行(从而出现一行数据导出了两行文本)。解决方法是加上\\转义字符。")]),t._v(" "),s("li",[t._v("导出命令不会生成表结构文件，因此"),s("font",{attrs:{color:"red"}},[s("strong",[t._v("导出之前还需要使用其它工具获取表结构定义")])]),t._v("。")],1)]),t._v(" "),s("p",[t._v("另外可以使用mysqldump工具"),s("font",{staticStyle:{background:"rgb(240, 240, 236)"},attrs:{color:"#d94a33"}},[s("strong",[t._v("-tab")])]),t._v("参数，直接同时导出表结构定义和csv数据文件：")],1),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[t._v("mysqldump "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("h$host "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("P$port "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("u$"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('---single-transaction  --set-gtid-purged=OFF db1 t --where="a>900" --tab=$secure_file_priv')]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("h3",{attrs:{id:"数据加载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据加载"}},[t._v("#")]),t._v(" 数据加载")]),t._v(" "),s("p",[t._v("最后执行以下load data命令"),s("strong",[t._v("将数据导入目标表")]),t._v("当中，考虑到"),s("font",{attrs:{color:"red"}},[s("strong",[t._v("主备复制")])]),t._v("的问题(statement格式下备库机器找不到csv文件，同步终止)，整个流程如下：")],1),t._v(" "),s("ol",[s("li",[s("p",[t._v("主库t2执行以下语句，完成数据导入：")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("load")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("data")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("infile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/server_tmp/t.csv'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("into")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("table")]),t._v(" db2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("主库会将csv文件内容直接写到binlog文件当中")]),t._v("。同时往binlog中写入如下语句(指定备库文件地址)：")]),t._v(" "),s("div",{staticClass:"language-sq line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("load data local infile ‘/tmp/SQL_LOAD_MB-1-0’ INTO TABLE `db2`.`t`;\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("备库的binlog同步应用线程(客户端)收到binlog后：")]),t._v(" "),s("ul",[s("li",[t._v("将csv文件读出并写入到''/tmp/SQL_LOAD_MB-1-0'("),s("strong",[t._v("执行同步应用线程的客户端的机器上")]),t._v(")")]),t._v(" "),s("li",[t._v("执行binlog中的load data语句")])])])]),t._v(" "),s("h2",{attrs:{id:"方法四、物理拷贝"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方法四、物理拷贝"}},[t._v("#")]),t._v(" 方法四、物理拷贝")]),t._v(" "),s("p",[t._v("一个InnoDB表除了包含"),s("strong",[t._v("表结构定义.frm文件")]),t._v("和"),s("strong",[t._v("表数据.ibd文件")]),t._v("，还需要"),s("font",{attrs:{color:"red"}},[s("strong",[t._v("在数据字典中注册")])]),t._v("，系统才能够接受和识别。")],1),t._v(" "),s("p",[t._v("因此单纯将两个文件拷贝到目标文件目录下，并不能真正实现表数据的拷贝。MySQL5.6引入"),s("font",{attrs:{color:"red"}},[s("strong",[t._v("可传输空间的方法")])]),t._v("：")],1),t._v(" "),s("ol",[s("li",[t._v("执行create table r like t，创建一个相同表结构的空表。")]),t._v(" "),s("li",[t._v("执行alter table r discard tablespace，此时删除r.ibd文件")]),t._v(" "),s("li",[t._v("执行"),s("strong",[t._v("flush table t for export")]),t._v("，此时db1目录下会生成一个t.cfg文件")]),t._v(" "),s("li",[t._v("db1目录下执行cp t.cfg r.cfg；cp t.ibd,r,ibd；两个命令复制源表的cfg文件和ibd数据。")]),t._v(" "),s("li",[t._v("执行unlock tables，此时t.cfg文件会被删除，并且释放读锁。")]),t._v(" "),s("li",[t._v("执行alter table r impory tablespace，"),s("strong",[t._v("将r.ibd文件作为表r新的表空间")]),t._v("，由于这个文件的数据内容和t.ibd是相同的，所以表r中就有了和表t相同的数据。")])]),t._v(" "),s("p",[t._v("✨如果出现误删表的情况，最快恢复的方法：①利用备份恢复误删之前的数据。②"),s("strong",[t._v("然后再将临时库中的表拷贝到生产库")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("💣mysqldump：可以通过"),s("font",{staticStyle:{background:"rgb(240, 240, 236)"},attrs:{color:"#d94a33"}},[s("strong",[t._v("–where")])]),t._v("添加可过滤字段，从而"),s("strong",[t._v("可以只导出部分数据")]),t._v("。缺点在于"),s("font",{attrs:{color:"red"}},[s("strong",[t._v("不能使用包含join的复杂条件where查询")])]),t._v("。")],1),t._v(" "),s("p",[t._v("💣导出csv：支持导出任意数据，"),s("strong",[t._v("并且支持所有SQL写法")]),t._v("。缺点在于只能导出一张表的数据，并且"),s("strong",[t._v("表结构需要另外的语句单独备份")]),t._v("。")]),t._v(" "),s("p",[t._v("💣物理拷贝："),s("font",{attrs:{color:"red"}},[s("strong",[t._v("速度最快")])]),t._v("。缺点在于①必须是全表拷贝，不能进行筛选备份部分数据。②"),s("strong",[t._v("必须到t1源表的服务器上拷贝数据")]),t._v("，执行对应语句和cfg文件。③源表和目标表都是使用InnoDB")],1)])}),[],!1,null,null,null);s.default=e.exports}}]);
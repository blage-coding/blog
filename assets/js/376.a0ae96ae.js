(window.webpackJsonp=window.webpackJsonp||[]).push([[376],{694:function(s,t,a){"use strict";a.r(t);var r=a(4),e=Object(r.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"sql语句性能差异分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sql语句性能差异分析"}},[s._v("#")]),s._v(" SQL语句性能差异分析")]),s._v(" "),t("h2",{attrs:{id:"案例一、条件字段的函数操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#案例一、条件字段的函数操作"}},[s._v("#")]),s._v(" 案例一、条件字段的函数操作")]),s._v(" "),t("p",[t("font",{attrs:{color:"red"}},[t("strong",[s._v("SQL查询语句中，如果在where条件限制字段时使用了函数，那么可能会导致该字段的索引失效，使用不上B+树的快速定位功能")])]),s._v("。")],1),s._v(" "),t("p",[s._v("需求&场景：统计所有记录中七月的交易记录总数。其中t_modified为datetime类型，并且添加了索引。")]),s._v(" "),t("p",[s._v("查询方式①")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("count")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tradelog "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("month")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t_modified"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("查询方式②")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("count")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tradelog "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t_modified "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2016-7-1'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" t_modified"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2016-8-1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("or")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t_modified "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2017-7-1'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" t_modified"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2017-8-1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("or")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t_modified "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2018-7-1'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" t_modified"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2018-8-1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("对于方式一，因为没有给出限定年份，"),t("strong",[s._v("搜索时不能走B+树的快速定位")]),s._v("。"),t("strong",[s._v("但并不代表不走这个索引")]),s._v("，对比发现索引t_modified叶子节点数据比主键索引叶子节点数据更小，所以最后还是走的"),t("strong",[s._v("全索引扫描")]),s._v("。")]),s._v(" "),t("p",[s._v("对于方式二，将函数操作改为范围查询，此时可以使用到B+树的快速定位功能。")]),s._v(" "),t("p",[s._v("另外优化器在判断解析where字段时，对于表达式而言"),t("strong",[s._v("等号左边只含有索引字段才能使用到索引")]),s._v("。具体来说 where id+1=10000和where id=10000-1只有后者会使用到索引。("),t("strong",[s._v("字段出现等号左边与右边没有影响，a=b和b=a等价")]),s._v(")")]),s._v(" "),t("h2",{attrs:{id:"案例二、隐式类型转换"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#案例二、隐式类型转换"}},[s._v("#")]),s._v(" 案例二、隐式类型转换")]),s._v(" "),t("p",[t("font",{attrs:{color:"red"}},[t("strong",[s._v("SQL数据类型隐式转换规则：在表达式中会自动将字符串类型转化成数字，再进行判断和比较")])]),s._v("。")],1),s._v(" "),t("p",[s._v("需求&场景：tradeid字段为varchar(32)类型，存在索引。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tradelog "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" tradeid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110717")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这条语句在查询时相当于给tradeid字段添加一个”转换函数“，从而"),t("strong",[s._v("使tradeid的索引B+树失效")]),s._v("，不能快速定位。")]),s._v(" "),t("h2",{attrs:{id:"案例三、隐式字符编码转换"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#案例三、隐式字符编码转换"}},[s._v("#")]),s._v(" 案例三、隐式字符编码转换")]),s._v(" "),t("p",[t("font",{attrs:{color:"red"}},[t("strong",[s._v("SQL字符编码隐式转换规则：在联表查询时，不同表之间字段的表达式进行比较时，会将编码格式为utf8的字段值转换成utf8mb4编码格式。因为utf8mb4时utf8的超集")])]),s._v("。")],1),s._v(" "),t("p",[s._v("需求&场景：d表中编码格式为utf8，而l表编码格式为utf8mb4。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" d "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tradeid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tradeid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("拿到l表的字段值在d表匹配查询时，"),t("strong",[s._v("d表的tradeid字段索引树需要转化为utf8mb4格式，因此索引失效")]),s._v("。")]),s._v(" "),t("p",[s._v("两种解决方案：")]),s._v(" "),t("ul",[t("li",[s._v("将d表的字段字符集也改成utf8mb4")]),s._v(" "),t("li",[s._v("在SQL语句直接修改d.tradeid的字符集编码格式")])]),s._v(" "),t("h2",{attrs:{id:"案例四、innodb引擎预处理与server层后处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#案例四、innodb引擎预处理与server层后处理"}},[s._v("#")]),s._v(" 案例四、InnoDB引擎预处理与server层后处理")]),s._v(" "),t("p",[s._v("需求&场景：b字段在InnoDB引擎定义了长度为VARCHAR(10)，数据库中存在十万条b='1234567890'的数据。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" t "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1234567890abcd'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这条查询语句虽然返回空，但是执行过程比较慢：")]),s._v(" "),t("ul",[t("li",[t("font",{staticStyle:{background:"rgb(255, 100, 38)"}},[t("strong",[s._v("innoDb引擎")])]),s._v("执行语句前，因为b字段只定义了十个字节，会进行"),t("strong",[s._v("字符截断")]),s._v("，只会拿‘1234567890’到索引树中进行行记录匹配。")],1),s._v(" "),t("li",[s._v("b索引树拿到id后，总共会进行十万次回表。")]),s._v(" "),t("li",[s._v("每次回表查出整行记录后，会到=="),t("strong",[s._v("server层")]),s._v("==进行"),t("strong",[s._v("一致性判断")]),s._v("，发现b='1234567890'不等于'1234567890abcd'")]),s._v(" "),t("li",[s._v("返回结果都为空")])]),s._v(" "),t("h2",{attrs:{id:"案例五、select-from-t-where-id-1执行慢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#案例五、select-from-t-where-id-1执行慢"}},[s._v("#")]),s._v(" 案例五、select * from t where id=1执行慢")]),s._v(" "),t("p",[s._v("执行以下单行查询语句发现速度慢，其中id为主键字段。")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("select "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" from t where id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("可能的原因、排查过程、解决方案如下：")]),s._v(" "),t("h3",{attrs:{id:"_1-等待mdl表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-等待mdl表锁"}},[s._v("#")]),s._v(" 1.等待MDL表锁")]),s._v(" "),t("p",[s._v("在会话A中因为执行了DDL语句，拿到"),t("strong",[s._v("MDL写锁")]),s._v("，"),t("strong",[s._v("只要会话A不提交事务那么MDL锁就不会释放")]),s._v("，从而导致会话B中的SQL语句被"),t("strong",[s._v("阻塞")]),s._v("。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsd.cdn.zzko.cn/gh/blage-coding/picx-images-hosting@master/20230629/image.71akk69bctc0.webp",alt:""}})]),s._v(" "),t("p",[s._v("💡"),t("strong",[s._v("解决方案")]),s._v("：找到具体是哪一个线程持有MDL写锁，然后kill掉。具体来说可以执行以下SQL语句查到对应的线程，其中"),t("font",{attrs:{color:"red"}},[t("strong",[s._v("表sys.schema_table_lock_waits是MySQL开机自动配置维护的一张系统表")])]),s._v("。")],1),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" blocking_pid "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("schema_table_lock_waits"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_2-等待flush表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-等待flush表锁"}},[s._v("#")]),s._v(" 2.等待flush表锁")]),s._v(" "),t("p",[t("font",{attrs:{color:"red"}},[t("strong",[s._v("flush操作：首先需要等待表上的所有操作执行完成，然后“关闭”表，最后执行flush")])]),s._v("。显然flush操作可以"),t("strong",[s._v("被前面的线程阻塞")]),s._v("，并且也"),t("strong",[s._v("会堵住阻塞")]),s._v("其它后面的线程。")],1),s._v(" "),t("p",[s._v("显然在下面场景中，sessionA因为一直对表t操作，"),t("strong",[s._v("导致sessionB要一直等待sessionA的查询结束")]),s._v("。这样sessionC中的查询语句就会被flush操作阻塞住了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsd.cdn.zzko.cn/gh/blage-coding/picx-images-hosting@master/20230629/image.4zfy04nvmfw0.webp",alt:""}})]),s._v(" "),t("p",[s._v("💡"),t("strong",[s._v("排查方案")]),s._v("："),t("font",{attrs:{color:"red"}},[t("strong",[s._v("从系统的processlist表中查询某个线程状态")])]),s._v("，可以发现状态字段为"),t("strong",[s._v("waiting for table flush")])],1),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" information_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("processlist "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("当前，可以直接执行如下语句查看所有的线程id的状态，找到对应flush语句的线程id后直接kill。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" processlist"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_3-等待行锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-等待行锁"}},[s._v("#")]),s._v(" 3.等待行锁")]),s._v(" "),t("p",[t("strong",[s._v("在RR隔离级别下，普通的查询语句因为是快照读，并不会被行锁阻塞")]),s._v("。若select想要当前读，执行以下SQL语句：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" t "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("share")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("显然既然是当前读，那么就可以被其它更新语句的行锁阻塞，sessionB只有等待sessionA提交事务释放行锁后，才能执行select语句。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsd.cdn.zzko.cn/gh/blage-coding/picx-images-hosting@master/20230629/image.5umtt5f7rgs0.webp",alt:""}})]),s._v(" "),t("p",[s._v("💡"),t("strong",[s._v("解决方案")]),s._v("：直接show processlist查看每个线程的状态位并不能解决问题，因此关键在于"),t("font",{attrs:{color:"red"}},[t("strong",[s._v("如何找到哪个线程id阻塞了sessionB的当前读")])]),s._v("？MySQL5.7版本可以借助"),t("strong",[s._v("sys.innodb_lock_waits")]),s._v("表查到：")],1),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" t sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("innodb_lock_waits "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" locked_table"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("'test'.'t'"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v("\\G\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("​\tKILL QUERY 4表示暂停事务中的查询语句，"),t("strong",[s._v("并不会提交事务释放锁")]),s._v("。只有执行KILL 4才能断开连接，回滚事务释放锁。")]),s._v(" "),t("h3",{attrs:{id:"_4-多更新版本号导致的查询慢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-多更新版本号导致的查询慢"}},[s._v("#")]),s._v(" 4.多更新版本号导致的查询慢")]),s._v(" "),t("p",[s._v("sessionA开启事务后，sessionB执行更新语句，"),t("strong",[s._v("id=1这行记录的版本号急剧增加")]),s._v("。")]),s._v(" "),t("ul",[t("li",[s._v("对于普通select查询，因为事务当前读，"),t("strong",[s._v("只能读到update语句之前的版本号")]),s._v("，因此行记录“当前版本号”需要根据undo log计算并"),t("font",{attrs:{color:"red"}},[t("strong",[s._v("向前回滚一万个版本号")])]),s._v("，而这个"),t("strong",[s._v("回滚计算的代价")]),s._v("在当前情况下是比较大的。")],1),s._v(" "),t("li",[s._v("而对于加了行锁的当前读的select查询，发现行记录的当前版本号就是当前读所需要的最新的数据，因此"),t("strong",[s._v("不需要任何回滚计算")]),s._v("。故此时"),t("strong",[s._v("当前读的查询时间和代价更小")]),s._v("。")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://jsd.cdn.zzko.cn/gh/blage-coding/picx-images-hosting@master/20230629/image.2ckx129fgvms.webp",alt:""}})])])}),[],!1,null,null,null);t.default=e.exports}}]);